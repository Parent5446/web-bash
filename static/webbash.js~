var prompt = "root@ubuntu> "
var ctrlDown = false;
var blink = false;

function resetCursor()
 {
	$( '#cursor' ).remove();
	$( "body > ul > li:last-child" ).append( $( '<div id="cursor">&nbsp;</div>' ) );
}

function displayPrompt() 
{
	$( "body > ul" ).append( '<li>' + prompt + '</li>' );
	resetCursor();
}

function executeCommand( txt ) 
{
	//alert( txt );
}



$( document ).keydown( function( e ) 
{
	if ( ctrlDown && e.keyCode == 67 ) 
	{
		$( 'ul > li' ).last().append( '^C' );
		displayPrompt();
	} 
	else if (e.keyCode == 37)
	{
		// left arrow
		var elem = $( '#cursor' ).prev();

		if ( elem.length != 0 && elem.hasClass( 'userinput' ) ) 
		{
			// previous elements so move cursor left
			if(elem.text() && elem.text().length > 1)
			{
				
				var elem2 = $( '<div class="userinput"></div>' );
				elem.before(elem2);
				var lastChar = elem.text().substring(elem.text().length-1);
				var beginningOfString = elem.text().substring(0, elem.text().length-1);

				elem2.text(beginningOfString);
				elem.text(lastChar);
			}
			var cursor = $( '#cursor' );
			cursor.remove();
			elem.before(cursor);
		}
	}
	else if (e.keyCode == 39)
	{
		// right arrow
		var elem = $( '#cursor' ).next();

		if ( elem.length != 0 && elem.hasClass( 'userinput' ) ) 
		{
			// next elements so move cursor right
			if(elem.text() && elem.text().length > 1)
			{
				var elem2 = $( '<div class="userinput"></div>' );
				elem.after(elem2);
				var firstChar = elem.text().substring(0, 1);
				var restOfString = elem.text().substring(1);

				elem2.text(restOfString);
				elem.text(firstChar);
			}
			var cursor = $( '#cursor' );
			cursor.remove();
			elem.after(cursor);
		}
	}
	else if(e.keyCode == 46)
	{
		var elem = $( '#cursor' ).next();
		if(elem.length != 0 && elem.hasClass('userinput'))
		{
			if(elem.text().length == 1)
				elem.remove();
			else
			{
				elem.text( elem.text().substring(1) );
			}
		}
	}
	else if ( e.keyCode > 31 && e.keyCode < 127 ) 
	{
		var elem = $( '#cursor' ).prev();

		if ( elem.length == 0 || !elem.hasClass( 'userinput' ) ) 
		{
			elem = $( '<div class="userinput"></div>' );
			$( '#cursor' ).before( elem );
		}
		elem.append( String.fromCharCode( e.keyCode ) );
	} 
	else if ( e.keyCode == 8 ) 
	{
		e.preventDefault();
		var elem = $( '#cursor' ).prev();
		if ( elem.length > 0 && elem.hasClass( 'userinput' ) ) 
		{
			if(elem.text().length > 1) {
				elem.text( elem.text().slice(0, -1) );	
			} else {
				elem.remove();
			}
		}
	}
	else if ( e.keyCode == 13 ) 
	{
		var elem = $( '#cursor' ).prev();
		var cmd = '';
		if ( elem.length > 0 && elem.hasClass( 'userinput' ) ) 
		{
			cmd = elem.text();
		}

		$( '#cursor' ).before( $( '<br>' ) );
		executeCommand( cmd );
		displayPrompt();
	} 
	else if ( e.keyCode == 17 ) 
	{
		ctrlDown = true;
	}

	$( window ).scrollTop( $( document ).height() );
} );

$( document ).keyup( function( e ) 
{
	if ( e.keyCode == 17 ) 
	{
		ctrlDown = false;
	}
} );

$( document ).ready( displayPrompt )
{
	var blink = function () {
		if( blink )
		{
			$( '#cursor' ).css( "opacity", 0 );
			blink = !blink;
		}
		else 
		{
			$( '#cursor' ).css( "opacity", 1 ); 
			blink = !blink;			
		}
	}

	window.setInterval( blink, 500 );
}
